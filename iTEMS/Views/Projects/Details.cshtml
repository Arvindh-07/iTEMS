@using System.IO
@model iTEMS.Models.Project

@{
    ViewData["Title"] = "Details";
}

<style>
    .small-icon {
        width: 50px; /* Adjust the width as needed */
        height: 70px; /* Adjust the height as needed */
        font-size: 20px; /* Adjust the icon size as needed */
        line-height: 30px; /* Ensure the icon is vertically centered */
    }
</style>




<br />
<br />
<br />
<div class="card-body" style="display: block;">
    <h3 style="font-family:Tahoma"><strong>Project Details</strong></h3>
    <br />
    <div class="row">
        <div class="col-12 col-md-12 col-lg-8 order-2 order-md-1">
            <div class="row">
                @* <div class="col-12 col-sm-3">
                    <div class="info-box bg-dark">
                        <div class="info-box-content">
                            <span class="info-box-text text-center text-muted">Estimated Budget</span>
                            <span class="info-box-number text-center text-muted mb-0">@Model.Budget</span>
                        </div>
                    </div>
                </div> *@
                <div class="col-12 col-sm-4">
                    <div class="info-box">
                        <span class="info-box-icon bg-info elevation-1 small-icon"><i class="fa-solid fa-dollar-sign"></i></span>
                        <div class="info-box-content">
                            <span class="info-box-text">Estimated Budget</span>
                            <span class="info-box-number">
                                @Model.Budget
                            </span>
                        </div>

                    </div>

                </div>
                <div class="col-12 col-sm-4">
                    <div class="info-box">
                        <span class="info-box-icon bg-warning elevation-1 small-icon"><i class="fa-solid fa-money-bill-1-wave"></i></span>
                        <div class="info-box-content">
                            <span class="info-box-text">Total Spent</span>
                            <span class="info-box-number">
                                @Model.TotalSpent
                            </span>
                        </div>

                    </div>

                </div>
                <div class="col-12 col-sm-4">
                    <div class="info-box">
                        <span class="info-box-icon bg-success elevation-1 small-icon"><i class="fa-solid fa-clock"></i></span>
                        <div class="info-box-content">
                            <span class="info-box-text">Estimated Duration</span>
                            <span class="info-box-number">
                                @Model.EstimatedDuration
                            </span>
                        </div>

                    </div>

                </div>
                @* <div class="col-12 col-sm-3">
                    <div class="info-box bg-dark">
                        <div class="info-box-content">
                            <span class="info-box-text text-center text-muted">Total Spent</span>
                            <span class="info-box-number text-center text-muted mb-0">@Model.TotalSpent</span> <!-- You need to replace this value -->
                        </div>
                    </div>
                </div> *@
               @*  <div class="col-12 col-sm-3">
                    <div class="info-box bg-dark">
                        <div class="info-box-content">
                            <span class="info-box-text text-center text-muted">Estimated Duration</span>
                            <span class="info-box-number text-center text-muted mb-0">@Model.EstimatedDuration</span> <!-- You need to replace this value -->
                        </div>
                    </div>
                </div> *@
                @* <div class="col-12 col-sm-3">
                    <div class="info-box bg-dark">
                        <div class="info-box-content">
                            <span class="info-box-text text-center text-muted">Status</span>
                            <span class="info-box-number text-center text-muted mb-0">@Model.Status</span> <!-- You need to replace this value -->
                        </div>
                    </div>
                </div> *@
            </div>

            @{
                // Define page size for timelines and attachments
                int timelinePageSize = 5; // Adjust this according to your needs
                int attachmentPageSize = 5; // Adjust this according to your needs

                // Calculate total number of pages for timelines and attachments
                int totalTimelineItems = Model.Timelines.Count;
                int totalAttachmentItems = Model.Attachments != null ? Model.Attachments.Count : 0;
                int totalTimelinePages = (int)Math.Ceiling((double)totalTimelineItems / timelinePageSize);
                int totalAttachmentPages = (int)Math.Ceiling((double)totalAttachmentItems / attachmentPageSize);

                // Retrieve current page numbers from query string for timelines and attachments
                int timelinePage = string.IsNullOrEmpty(Context.Request.Query["timelinePage"]) ? 1 : Convert.ToInt32(Context.Request.Query["timelinePage"]);
                int attachmentPage = string.IsNullOrEmpty(Context.Request.Query["attachmentPage"]) ? 1 : Convert.ToInt32(Context.Request.Query["attachmentPage"]);

                // Calculate starting and ending indices for timelines and attachments
                int timelineStartIndex = (timelinePage - 1) * timelinePageSize;
                int timelineEndIndex = Math.Min(timelineStartIndex + timelinePageSize - 1, totalTimelineItems - 1);
                int attachmentStartIndex = (attachmentPage - 1) * attachmentPageSize;
                int attachmentEndIndex = Math.Min(attachmentStartIndex + attachmentPageSize - 1, totalAttachmentItems - 1);

                // Get the current page of timelines
                var paginatedTimelines = Model.Timelines.OrderByDescending(t => t.Timestamp).Skip(timelineStartIndex).Take(timelinePageSize).ToList();
            }
            <div class="row">
                <div class="col-12">
                    <h3 style="font-family:Tahoma"><strong>Project Timeline</strong></h3>
                    @foreach (var entry in Model.Timelines.OrderByDescending(t => t.Timestamp).Skip(timelineStartIndex).Take(timelinePageSize))
                    {
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="user-block">
                                        <img class="img-circle img-bordered-sm" src="~/assets/profile_pic.png" alt="user image">
                                        <span class="username">
                                            <h4>@entry.UserInvolved</h4>
                                        </span>
                                        <span class="description">@entry.Timestamp.ToString("dd-MMMM-yyyy HH:mm:ss")</span>
                                    </div>
                                    <!-- Delete button -->
                                    @if (User.IsInRole("Super Admin"))
                                    {
                                        <form asp-action="DeleteTimelineEntryConfirmed" asp-controller="Projects" asp-route-id="@entry.Id" method="post" class="ml-auto" title="Delete Entry">
                                            <button type="submit" class="close" aria-label="Close" onclick="return confirm('Are you sure you want to delete this timeline entry?');">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </form>
                                    }
                                </div>
                                <p class="card-text">
                                    @switch (entry.Type)
                                    {
                                        case "File Uploaded":
                                            <text>@entry.UserInvolved has uploaded a file: <a href="@Url.Action("DownloadFile", "Projects", new { id = Model.Id, fileName = entry.FileName })">@entry.FileName</a></text>
                                            break;
                                        case "Update Posted":
                                            <text>@entry.Description</text>
                                            break;
                                        case "Status Change":
                                            <text>@entry.Description</text>
                                            break;
                                        default:
                                            <text>@entry.Description</text>
                                            break;
                                    }
                                </p>
                            </div>
                        </div>
                    }
                </div>
            </div>
            @if (totalTimelinePages > 1)
            {
                <div class="row">
                    <div class="col-12">
                        <ul class="pagination">
                            @for (int i = 1; i <= totalTimelinePages; i++)
                            {
                                <li class="page-item @(i == timelinePage ? "active" : "")">
                                    <a class="page-link" href="?timelinePage=@i&attachmentPage=@attachmentPage">@i</a>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            }
        </div>

        <div class="col-12 col-md-12 col-lg-4 order-1 order-md-2">
            <div class="card" style="width: 100%; margin-bottom: 20px;">
                <div class="card-body">
                    <h5 class="card-title text-muted">Project Name</h5>
                    <h3 class="card-text" style="font-family: Tahoma;"><strong>@Model.Name</strong></h3>
                    <hr>
                    <h5 class="card-title text-muted">Description</h5>
                    <p class="card-text"><strong>@Model.Description</strong></p>
                    <hr>
                    <h5 class="card-title text-muted">Client Name</h5>
                    <p class="card-text"><strong>@Model.ClientName</strong></p>
                    <hr>
                    <h5 class="card-title text-muted">Project Leader</h5>
                    <p class="card-text"><strong>@Model.PIC</strong></p>
                </div>
            </div>


            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="text-muted" style="font-family:Tahoma">Project files</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        @if (totalAttachmentItems > 0)
                        {
                            for (int i = attachmentStartIndex; i <= attachmentEndIndex; i++)
                            {
                                <li>
                                    <a href="@Url.Action("DownloadFile", "Projects", new { id = Model.Id })" download="@System.IO.Path.GetFileName(Model.Attachments[i])">@System.IO.Path.GetFileName(Model.Attachments[i])</a>
                                </li>
                            }
                        }
                        else
                        {
                            <li>
                                <span>No files uploaded</span>
                            </li>
                        }
                    </ul>
                    @if (totalAttachmentPages > 1)
                    {
                        <div class="row">
                            <div class="col-12">
                                <ul class="pagination">
                                    @for (int i = 1; i <= totalAttachmentPages; i++)
                                    {
                                        <li class="page-item @(i == attachmentPage ? "active" : "")">
                                            <a class="page-link" href="?attachmentPage=@i">@i</a>
                                        </li>
                                    }
                                </ul>
                            </div>
                        </div>
                    }
                </div>
            </div>




@*             <div class="text-center mt-5 mb-3">
                <form asp-action="UploadFiles" asp-route-id="@Model.Id" method="post" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="files">Select files:</label>
                        <input type="file" name="files" id="files" multiple />
                    </div>
                    <button type="submit" class="btn btn-primary">Upload Files</button>
                </form>
            </div> *@
        </div>
    </div>
</div>

<div class="form-group">
    <a class="btn btn-outline-info" asp-action="Index" title="Back to Projects List" onmouseover="this.style.backgroundColor='#007bff';" onmouseout="this.style.backgroundColor='';"><i class="fa-solid fa-arrow-left-long"></i></a>
</div>
